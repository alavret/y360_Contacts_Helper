# Документация по скрипту y360_contacts.py

## Описание

Скрипт предназначен для управления личными контактами пользователей в Яндекс 360 через CardDAV API. Позволяет выполнять массовые операции с контактами для нескольких пользователей одновременно.

## Требования

- Python 3.10+
- Пакеты из `requirements.txt`
- OAuth токен с необходимыми правами доступа
- Сервисное приложение для получения токенов пользователей

## Настройка

### Файл .env

Создайте файл `.env` в директории со скриптом со следующими параметрами:

```bash
# Обязательные параметры
OAUTH_TOKEN=<ваш_oauth_token>
ORG_ID=<id_организации>
SERVICE_APP_ID=<id_сервисного_приложения>
SERVICE_APP_SECRET=<секрет_сервисного_приложения>

# Необязательные параметры
USERS_FILE=users.csv                    # Файл с пользователями (по умолчанию: users.csv)
DRY_RUN=false                           # Режим тестирования без изменений (true/false)
VCARD_FOLDER=vcard                      # Папка для экспорта контактов (по умолчанию: vcard)
CONTACT_COLLECT_STATUS_BASE_NAME=collect_status  # Базовое имя файла для статусов автосбора
```

### Необходимые права OAuth токена

Скрипт требует следующих прав доступа:
- `directory:read_users` - чтение информации о пользователях

## Режимы работы

Скрипт работает в интерактивном режиме с меню. После запуска доступны следующие опции:

### 1. Выгрузка пользователей в файл

**Описание:** Выгружает всех пользователей организации из API Яндекс 360 в CSV файл.

**Формат выходного файла:** CSV с разделителем `;` содержит все атрибуты пользователя, возвращаемые API.

**Использование:**
```bash
python y360_contacts.py
# Выберите опцию 1
```

**Результат:** Создается файл, указанный в параметре `USERS_FILE` (по умолчанию `users.csv`).

---

### 2. Удаление всех контактов выбранных пользователей

**Описание:** Полностью удаляет все личные контакты указанных пользователей.

**Варианты ввода пользователей:**

#### Вариант 1: По алиасу (nickname)
```
Enter users aliases or uid or last name: ivanov
```

#### Вариант 2: По нескольким алиасам (через запятую, пробел или точку с запятой)
```
Enter users aliases or uid or last name: ivanov, petrov sidorov
```

#### Вариант 3: По UID пользователя (16-значный идентификатор, начинающийся с 113)
```
Enter users aliases or uid or last name: 1130000000000001
```

#### Вариант 4: По фамилии
```
Enter users aliases or uid or last name: Иванов
```
**Внимание:** Если несколько пользователей имеют одинаковую фамилию, скрипт выведет список и попросит уточнить запрос.

#### Вариант 5: По email (без домена или с доменом)
```
Enter users aliases or uid or last name: ivanov@company.ru
# или
Enter users aliases or uid or last name: ivanov
```

#### Вариант 6: Все пользователи организации
```
Enter users aliases or uid or last name: *
```

#### Вариант 7: Загрузка из файла
```
Enter users aliases or uid or last name: !
```
Загружает email адреса из файла, указанного в `USERS_FILE`.

**Примеры комбинированного ввода:**
```
ivanov petrov 1130000000000001 Сидоров
ivanov@company.ru, petrov sidorov
```

**Подтверждение операции:**
```
Confirm removal of all contacts for 3 users? (y/n): y
```

**Режим DRY_RUN:**
При установке `DRY_RUN=true` операция не выполняется, только выводится список контактов для удаления.

---

### 3. Удаление контактов по шаблонам email

**Описание:** Удаляет из контактов пользователей только те email адреса, которые соответствуют заданным шаблонам.

**Варианты ввода пользователей:** См. раздел "Удаление всех контактов" выше.

**Форматы шаблонов для удаления email:**

#### Шаблон 1: Точный email адрес
```
Enter email templates to delete: test@example.com
```
Удалит точное совпадение `test@example.com`.

#### Шаблон 2: Все адреса в домене
```
Enter email templates to delete: *@example.com
```
Удалит все адреса с доменом `example.com` (например: `user@example.com`, `admin@example.com`).

#### Шаблон 3: Все адреса в поддоменах
```
Enter email templates to delete: *.example.com
```
Удалит все адреса с поддоменами `example.com` (например: `user@mail.example.com`, `admin@hr.example.com`).

#### Шаблон 4: Конкретный алиас в любом домене
```
Enter email templates to delete: admin@*
```
Удалит все адреса с алиасом `admin` в любом домене (например: `admin@example.com`, `admin@test.ru`).

#### Шаблон 5: Только домен (без @)
```
Enter email templates to delete: example.com
```
Удалит все адреса с доменом `example.com`.

#### Шаблон 6: Несколько шаблонов
```
Enter email templates to delete: *@example.com test@*.ru admin@*
```
Можно указывать несколько шаблонов, разделяя их пробелами, запятыми или точками с запятой.

**Валидация шаблонов:**
Разрешены только символы: буквы, цифры, точка (`.`), дефис (`-`), собака (`@`) и звездочка (`*`).

**Логика работы:**
- Если в контакте только один email и он соответствует шаблону - контакт удаляется полностью
- Если в контакте несколько email - удаляются только совпадающие адреса, контакт остается

**Пример:**
```
Enter users: ivanov petrov
Found 2 users to delete emails from.

Enter email templates to delete: *@old-domain.com *.temp.com
Confirm removal of matching email entries from contacts of 2 users? (y/n): y
```

---

### 4. Замена email адресов в контактах

**Описание:** Заменяет email адреса в контактах пользователей по заданному шаблону.

**Варианты ввода пользователей:** См. раздел "Удаление всех контактов" выше.

**Форматы шаблонов для замены:**

Ввод осуществляется в формате: `<шаблон_поиска> <шаблон_замены>`

#### Пример 1: Замена домена
```
Введите через пробел два выражения: *@old.com *@new.com
```
**Результат:**
- `user@old.com` → `user@new.com`
- `admin@old.com` → `admin@new.com`

#### Пример 2: Замена поддомена
```
Введите через пробел два выражения: *@mail.old.com *@new.com
```
**Результат:**
- `user@mail.old.com` → `user@new.com`

#### Пример 3: Замена алиаса
```
Введите через пробел два выражения: old-*@domain.com new-*@domain.com
```
**Результат:**
- `old-user@domain.com` → `new-user@domain.com`
- `old-admin@domain.com` → `new-admin@domain.com`

#### Пример 4: Сложная замена с несколькими wildcard
```
Введите через пробел два выражения: *@*.old.com *@*.new.com
```
**Результат:**
- `user@mail.old.com` → `user@mail.new.com`
- `admin@hr.old.com` → `admin@hr.new.com`

#### Пример 5: Замена с перестановкой
```
Введите через пробел два выражения: *-*@domain.com *.*@domain.com
```
**Результат:**
- `first-second@domain.com` → `first.second@domain.com`

**Правила работы wildcard (*):**
- `*` в шаблоне поиска захватывает любую последовательность символов
- `*` в шаблоне замены заменяется на захваченное значение
- Если в шаблонах несколько `*`, они сопоставляются по порядку

**Валидация:**
- Шаблоны должны содержать только буквы, цифры, точку, дефис, @ и *
- Оба шаблона обязательны
- Шаблоны не должны быть пустыми

**Подтверждение:**
```
Подтвердите замену email по шаблону '*@old.com' -> '*@new.com' для 5 пользователей? (y/n):
```

---

### 5. Экспорт контактов в VCF

**Описание:** Сохраняет личные контакты пользователей в VCF файлы (формат vCard).

**Варианты ввода пользователей:** См. раздел "Удаление всех контактов" выше.

**Формат выходных файлов:**
- Имя файла: `{алиас}_{timestamp}.vcf`
  - Пример: `ivanov_260114_143025.vcf`
- Формат timestamp: `YYMMDD_HHMMSS`
- Директория: указывается в параметре `VCARD_FOLDER` (по умолчанию: `vcard`)

**Содержимое:**
- Один VCF файл на пользователя
- Содержит все контакты из личной адресной книги
- Формат vCard 3.0/4.0 (в зависимости от источника)

**Использование:**
```
Enter users: ivanov petrov sidorov
Found 3 users to export contacts for.

Сохранить контакты для 3 пользователей в каталог 'vcard'? (y/n): y

[ivanov@company.ru] Экспортировано 45 контактов в vcard/ivanov_260114_143025.vcf
[petrov@company.ru] Экспортировано 32 контакта в vcard/petrov_260114_143025.vcf
[sidorov@company.ru] Контактов не найдено, экспорт пропущен.

Экспорт завершен. Создано файлов: 2. Всего контактов выгружено: 77
```

**Примечания:**
- Экспортируются только личные контакты (addressbook "Personal")
- Если у пользователя нет контактов, файл не создается
- Файлы создаются с кодировкой UTF-8

---

### 6. Выгрузка статуса автосбора контактов

**Описание:** Выгружает информацию о статусе автоматического сбора контактов для выбранных пользователей.

**Варианты ввода пользователей:** См. раздел "Удаление всех контактов" выше.

**Формат выходного файла:**
- Имя файла: `{базовое_имя}_{timestamp}.csv`
  - Пример: `collect_status_260114_143025.csv`
- Формат: CSV с разделителем `;`
- Кодировка: UTF-8

**Структура CSV:**
```csv
email;collectAddresses
ivanov@company.ru;True
petrov@company.ru;False
sidorov@company.ru;True
```

**Поля:**
- `email` - email адрес пользователя
- `collectAddresses` - статус автосбора (True/False)

**Использование:**
```
Enter users: *
Saved collectAddresses status for 150 users to collect_status_260114_143025.csv
Export completed successfully.
```

---

### 7. Включение автосбора контактов

**Описание:** Включает автоматический сбор контактов для выбранных пользователей.

**Варианты ввода пользователей:** См. раздел "Удаление всех контактов" выше.

**Что делает:**
- Устанавливает параметр `collectAddresses` в `true` для почтовых настроек пользователя
- После включения, email адреса из входящих/исходящих писем автоматически добавляются в личную адресную книгу

**Использование:**
```
Enter users: ivanov petrov
Change auto-collect contacts to enable for 2 users? (y/n): y

Success - collectAddresses set to True for user 1130000000000001
Success - collectAddresses set to True for user 1130000000000002
Changed auto-collect to enable for 2 of 2 users.
```

---

### 8. Отключение автосбора контактов

**Описание:** Отключает автоматический сбор контактов для выбранных пользователей.

**Варианты ввода пользователей:** См. раздел "Удаление всех контактов" выше.

**Что делает:**
- Устанавливает параметр `collectAddresses` в `false` для почтовых настроек пользователя
- После отключения, новые адреса не будут автоматически добавляться в адресную книгу

**Использование:**
```
Enter users: *
Change auto-collect contacts to disable for 145 users? (y/n): y

Success - collectAddresses set to False for user 1130000000000001
...
Changed auto-collect to disable for 145 of 145 users.
```

---

## Режим DRY_RUN

При установке в `.env` параметра `DRY_RUN=true` скрипт работает в режиме симуляции:
- Все операции записи (удаление, изменение) не выполняются
- Выводится информация о том, что было бы выполнено
- Позволяет проверить корректность операций без внесения изменений

**Пример вывода в DRY_RUN режиме:**
```
Dry run включен: контакты удаляться не будут, показываем только список.
[ivanov@company.ru] Dry run: would delete contact https://carddav.yandex.ru/addressbook/ivanov@company.ru/contact-123.vcf
```

---

## Формат файла users.csv

Файл для массовой загрузки пользователей должен содержать колонку `Email`:

```csv
Email
ivanov@company.ru
petrov@company.ru
sidorov@company.ru
```

**Поддерживаемые варианты:**
- `Email` (регистр не важен)
- `email`
- `EMAIL`
- Кодировка: UTF-8 с BOM или без

**Загрузка из файла:**
```
Enter users: !
```
или запуск с параметром `use_file=True` для соответствующих функций.

---

## Логирование

Скрипт ведет подробный лог работы:

**Файл лога:** `y360_contacts.log`

**Уровни логирования:**
- **DEBUG** - детальная информация о всех запросах к API (только в файл)
- **INFO** - информация о ходе выполнения операций (консоль + файл)
- **ERROR** - ошибки выполнения (консоль + файл)

**Ротация логов:**
- Максимальный размер файла: 10 МБ
- Количество хранимых файлов: 5
- При достижении лимита создается новый файл с суффиксом `.1`, `.2` и т.д.

**Пример записей:**
```
2026-01-14 14:30:25.123 INFO:     Запуск скрипта.
2026-01-14 14:30:25.456 INFO:     Проверка прав доступа для токена пользователя: admin
2026-01-14 14:30:25.789 INFO:     ✓ Все необходимые права доступа присутствуют
2026-01-14 14:30:26.012 DEBUG:    GET URL - https://api360.yandex.net/directory/v1/org/12345/users
```

---

## Примеры использования

### Пример 1: Массовое удаление старых email из контактов

**Задача:** Удалить все email адреса со старого домена `@old-company.com` из контактов всех пользователей.

```bash
python y360_contacts.py
# Выберите: 3
# Enter users: *
# Enter email templates to delete: *@old-company.com
# Confirm removal: y
```

### Пример 2: Замена домена в контактах

**Задача:** Заменить домен `@old.com` на `@new.com` в контактах отдела продаж.

```bash
python y360_contacts.py
# Выберите: 4
# Enter users: ivanov petrov sidorov kuznetsov
# Введите шаблоны: *@old.com *@new.com
# Подтвердите: y
```

### Пример 3: Экспорт контактов перед миграцией

**Задача:** Сохранить контакты всех пользователей перед обновлением системы.

```bash
python y360_contacts.py
# Выберите: 5
# Enter users: *
# Сохранить контакты: y
```

### Пример 4: Отключение автосбора для внешних пользователей

**Задача:** Отключить автосбор контактов для пользователей из файла `external_users.csv`.

Создайте `.env`:
```bash
USERS_FILE=external_users.csv
...
```

Запустите:
```bash
python y360_contacts.py
# Выберите: 8
# Enter users: !
# Подтвердите: y
```

### Пример 5: Проверка операции в DRY_RUN режиме

**Задача:** Проверить, какие контакты будут удалены, без реального удаления.

В `.env`:
```bash
DRY_RUN=true
```

```bash
python y360_contacts.py
# Выберите: 2
# Enter users: testuser
# Confirm: y
# Скрипт покажет список контактов без удаления
```

---

## Обработка ошибок

### Ошибки токена

```
OAUTH_TOKEN не является действительным или не имеет необходимых прав доступа
```
**Решение:** Проверьте срок действия токена и наличие прав `directory:read_users`.

### Ошибки доступа к организации

```
ОШИБКА: Токен не имеет доступа к организации с ID 12345
```
**Решение:** Убедитесь, что `ORG_ID` указан корректно и токен имеет доступ к этой организации.

### Ошибки при работе с контактами

```
Failed to PROPFIND addressbook home: 401 Unauthorized
```
**Решение:** Проверьте настройки сервисного приложения (`SERVICE_APP_ID` и `SERVICE_APP_SECRET`).

### Повторные попытки

Скрипт автоматически повторяет неудачные запросы:
- Максимум попыток: 3 (`MAX_RETRIES`)
- Задержка между попытками: 2 секунды * номер попытки

```
Повторная попытка (2/3)
```

---

## Технические детали

### API эндпоинты

- **API 360:** `https://api360.yandex.net`
- **CardDAV:** `https://carddav.yandex.ru/addressbook`
- **OAuth:** `https://oauth.yandex.ru/token`

### Ограничения

- Пользователей на страницу: 1000
- Максимум повторных попыток: 3
- Задержка между API вызовами: 0.5 сек
- Кэширование пользователей: 15 минут

### Фильтры пользователей

Скрипт автоматически исключает:
- Роботов (`isRobot: true`)
- Системных пользователей (ID < 1130000000000000)

### Работа с vCard

Скрипт обрабатывает vCard записи напрямую через регулярные выражения:
- Поддерживаются различные форматы EMAIL строк
- Сохраняются все параметры EMAIL (TYPE, PREF и т.д.)
- Автоматическое определение формата переноса строк (CRLF/LF)

---

## Безопасность

### Хранение токенов

- Все токены хранятся в `.env` файле
- Добавьте `.env` в `.gitignore`
- Не передавайте токены в логах (DEBUG уровень содержит чувствительные данные)

### Сервисное приложение

Для работы с контактами пользователей скрипт использует механизм Service Application:
- Получает временные токены от имени пользователей
- Требует `SERVICE_APP_ID` и `SERVICE_APP_SECRET`
- Работает через OAuth token exchange

### Рекомендации

- Регулярно обновляйте OAuth токены
- Используйте DRY_RUN для проверки операций
- Делайте резервные копии контактов перед массовыми изменениями (опция 5)
- Проверяйте логи на наличие ошибок

---

## Часто задаваемые вопросы

**Q: Можно ли отменить удаление контактов?**
A: Нет, операция необратима. Используйте опцию 5 для создания резервной копии перед удалением, или DRY_RUN для проверки.

**Q: Обрабатываются ли общие адресные книги?**
A: Нет, скрипт работает только с личными контактами (addressbook "Personal").

**Q: Что делать, если скрипт падает с ошибкой?**
A: Проверьте файл `y360_contacts.log` для детальной информации об ошибке. Убедитесь, что все настройки в `.env` корректны.

**Q: Как узнать UID пользователя?**
A: Используйте опцию 1 для выгрузки всех пользователей, в файле будет колонка `id`.

**Q: Можно ли использовать скрипт для разных организаций?**
A: Да, создайте разные `.env` файлы с разными `ORG_ID` и переключайтесь между ними.

**Q: Работает ли wildcard * в середине слова?**
A: Да, например `user*@domain.com` найдет `user1@domain.com`, `user_admin@domain.com` и т.д.

**Q: Можно ли указать несколько wildcard в одном шаблоне?**
A: Да, например `*-*@*.com` для замены `first-last@mail.com`.

**Q: Как часто обновляется кэш пользователей?**
A: Каждые 15 минут. Для принудительного обновления перезапустите скрипт.

---

## Поддержка

При возникновении проблем:
1. Проверьте файл `y360_contacts.log`
2. Убедитесь, что все параметры в `.env` корректны
3. Попробуйте запустить с `DRY_RUN=true`
4. Проверьте права доступа OAuth токена

---

## Версия

Документация актуальна для версии скрипта от 14.01.2026
